<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OKLCH Ramp Builder + Live Preview (Cards • Modal • Tabs • Accordion • Sliders)</title>
<style>
  :root {
    --bg: #0b0c10;
    --panel: #101216;
    --border: #1e222b;
    --text: #e6e7ea;
    --muted: #a8aeb9;
    --brand: #7B458F;
    --radius: 12px;
  }
  html, body { height: 100%; }
  body {
    margin: 0; font-family: system-ui, ui-sans-serif, Segoe UI, Roboto, Arial;
    background: var(--bg); color: var(--text); line-height: 1.5;
  }
  .wrap { max-width: 1300px; margin: 0 auto; padding: 24px; }
  h1 { margin: 0 0 12px; }
  .layout { display: grid; gap: 18px; grid-template-columns: 520px 1fr; align-items: start; }
  @media (max-width: 1100px){ .layout { grid-template-columns: 1fr; } }
  .card {
    background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 16px;
  }
  label { display: block; font-weight: 600; margin: 8px 0 6px; }
  .muted { color: var(--muted); font-size: 0.95rem; }
  input[type="text"], input[type="number"], textarea {
    width: 100%; background: #0f1116; color: var(--text); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 12px; font-family: inherit;
  }
  textarea { min-height: 84px; resize: vertical; }
  .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .btn {
    background: var(--brand); color: white; border: 1px solid #542e64;
    border-radius: 10px; padding: 10px 14px; font-weight: 700; cursor: pointer;
  }
  .btn:hover { filter: brightness(1.05); }
  .btn.secondary { background: transparent; color: var(--brand); border-color: var(--brand); }
  .btn.tertiary { background: #0f1116; color: var(--text); border-color: var(--border); }
  .btn.small { padding: 8px 10px; font-weight: 700; }
  pre { background: #0f1116; border: 1px solid var(--border); border-radius: 10px; padding: 12px; max-height: 420px; overflow: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
  th, td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
  th { text-align: left; color: var(--muted); font-weight: 600; }
  .swatches { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px,1fr)); gap: 10px; margin-top: 10px; }
  .swatch {
    border-radius: 10px; border: 1px solid var(--border); padding: 10px; display: grid; place-items: end start;
    min-height: 70px; box-shadow: 0 1px 2px rgba(0,0,0,.25);
  }
  .tag { background: rgba(0,0,0,.35); border: 1px solid rgba(255,255,255,.12); padding: 2px 6px; font-size: .75rem; border-radius: 6px; }

  /* PREVIEW SIDE */
  .preview { display: grid; gap: 16px; grid-template-rows: auto auto 1fr auto auto; }
  .preview-toolbar { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
  .chip { background: var(--preview-color-brand-soft, #eee); color: var(--preview-color-brand, #333); border-radius: 999px; padding: 4px 8px; font-weight: 700; border: 1px solid #0000001a; }
  .preview-canvas { border-radius: var(--radius); border: 1px solid var(--border); overflow: clip; }
  .preview-header {
    display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 12px;
    padding: 12px 16px; border-bottom: 1px solid var(--preview-color-border);
    background: var(--preview-color-surface);
  }
  .nav { display: inline-flex; gap: .6rem; }
  .nav-link { display: inline-flex; padding: .45rem .6rem; border-radius: 8px; text-decoration: none; color: var(--preview-color-text); }
  .nav-link[aria-current="page"] { color: var(--preview-color-brand); font-weight: 700; }
  .nav-link:hover { background: var(--preview-color-elevated); }

  .hero { padding: 28px 16px; background: linear-gradient(180deg, color-mix(in oklab, var(--preview-color-brand) 12%, transparent), transparent); }
  .hero h2 { color: var(--preview-color-brand); margin: 0 0 .25rem; }
  .hero p { color: var(--preview-color-text-muted); margin: 0; }
  .hero-actions { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }

  .button {
    --btn-bg: var(--preview-color-brand);
    --btn-fg: var(--preview-text-on-brand);
    background: var(--btn-bg); color: var(--btn-fg);
    border: 1px solid color-mix(in oklab, var(--btn-bg) 80%, black);
    border-radius: 10px; padding: .55rem .9rem; font-weight: 700; cursor: pointer;
  }
  .button:hover { background: var(--preview-color-brand-hover); color: var(--preview-text-on-brand-hover); }
  .button:active { background: var(--preview-color-brand-active); color: var(--preview-text-on-brand-hover); }
  .button--soft { background: var(--preview-color-brand-soft); color: var(--preview-text-on-brand-soft); border: 1px solid color-mix(in oklab, var(--preview-color-brand) 18%, transparent); }
  .button--outline { background: transparent; color: var(--preview-color-brand); border: 1px solid var(--preview-color-brand); }
  .button--outline:hover { background: var(--preview-color-brand); color: var(--preview-text-on-brand); }

  .section { padding: 16px; border-top: 1px solid var(--preview-color-border); background: var(--preview-color-surface); }
  .grid3 { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
  .card { background: var(--preview-color-surface); border: 1px solid var(--preview-color-border); border-radius: 12px; padding: 12px; }

  .alert { border-radius: 12px; padding: .75rem 1rem; border: 1px solid transparent; }
  .alert--success { background: var(--preview-success-soft); color: var(--preview-success); border-color: color-mix(in oklab, var(--preview-success) 25%, transparent); }
  .alert--warning { background: var(--preview-warning-soft); color: var(--preview-warning); border-color: color-mix(in oklab, var(--preview-warning) 25%, transparent); }
  .alert--danger  { background: var(--preview-danger-soft);  color: var(--preview-danger);  border-color: color-mix(in oklab, var(--preview-danger) 25%, transparent); }

  .input, .select, .textarea { width: 100%; background: var(--preview-color-elevated); color: var(--preview-color-text); border: 1px solid var(--preview-color-border); border-radius: 10px; padding: .55rem .7rem; }
  .label { font-weight: 700; display: block; margin-bottom: 6px; }
  .actions { display: flex; gap: 10px; flex-wrap: wrap; }

  /* Badges */
  .badge { border-radius: 999px; padding: .25rem .6rem; font-weight: 800; font-size: .75rem; display: inline-flex; align-items: center; gap:.35rem; }
  .badge--brand   { background: var(--preview-color-brand-soft);   color: var(--preview-color-brand); border: 1px solid color-mix(in oklab, var(--preview-color-brand) 18%, transparent); }
  .badge--muted   { background: var(--preview-color-elevated);     color: var(--preview-color-text);  border: 1px solid var(--preview-color-border); }
  .badge--success { background: var(--preview-success-soft);        color: var(--preview-success);     border: 1px solid color-mix(in oklab, var(--preview-success) 25%, transparent); }
  .badge--warning { background: var(--preview-warning-soft);        color: var(--preview-warning);     border: 1px solid color-mix(in oklab, var(--preview-warning) 25%, transparent); }
  .badge--danger  { background: var(--preview-danger-soft);         color: var(--preview-danger);      border: 1px solid color-mix(in oklab, var(--preview-danger) 25%, transparent); }

  /* Tabs */
  .tabs { display: grid; gap: 10px; }
  .tablist { display: inline-flex; gap: 6px; border-bottom: 1px solid var(--preview-color-border); }
  .tab { appearance: none; border: 1px solid var(--preview-color-border); background: var(--preview-color-elevated); color: var(--preview-color-text); padding: .5rem .8rem; border-radius: 8px 8px 0 0; cursor: pointer; }
  .tab[aria-selected="true"] { background: var(--preview-color-surface); border-bottom-color: var(--preview-color-surface); color: var(--preview-color-brand); font-weight: 800; }
  .tabpanel { border: 1px solid var(--preview-color-border); border-radius: 0 8px 8px 8px; padding: 12px; }

  /* Accordion */
  .accordion { display: grid; gap: 8px; }
  .accordion-item { border: 1px solid var(--preview-color-border); border-radius: 10px; background: var(--preview-color-surface); }
  .accordion-header { display: flex; justify-content: space-between; align-items: center; padding: .6rem .8rem; width: 100%; background: var(--preview-color-surface); color: var(--preview-color-text); border: 0; border-radius: 10px; cursor: pointer; }
  .accordion-header:focus-visible { outline: 2px solid var(--preview-color-brand); outline-offset: 2px; }
  .accordion-panel { padding: 0 .8rem .8rem; display: none; }
  .accordion-item[aria-expanded="true"] .accordion-panel { display: block; }

  /* Modal */
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; }
  .modal-backdrop[aria-hidden="false"] { display: grid; place-items: center; }
  .modal {
    background: var(--preview-modal-surface, var(--preview-color-surface));
    color: var(--preview-modal-text, var(--preview-color-text));
    border: 1px solid var(--preview-color-border); border-radius: 12px; padding: 16px; width: min(560px, 92vw);
    box-shadow: 0 10px 30px rgba(0,0,0,.45);
  }
  .modal header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .modal header h3 { margin: 0; color: var(--preview-modal-heading, var(--preview-color-brand)); }
  .modal footer { display: flex; gap: 10px; justify-content: end; margin-top: 12px; }

  .button.primary { --btn-bg: var(--preview-modal-primary-bg); --btn-fg: var(--preview-modal-primary-fg); }
  .button.secondary { --btn-bg: var(--preview-modal-secondary-bg); --btn-fg: var(--preview-modal-secondary-fg); }

  /* Sliders */
  .range-row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; }
  input[type="range"] { width: 100%; background: transparent; }
  input[type="range"]::-webkit-slider-runnable-track { height: 6px; border-radius: 999px; background: var(--preview-color-elevated); border: 1px solid var(--preview-color-border); }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -6px; width: 18px; height: 18px; border-radius: 50%; background: var(--preview-color-brand); border: 1px solid color-mix(in oklab, var(--preview-color-brand) 65%, black); }
  input[type="range"]::-moz-range-track { height: 6px; border-radius: 999px; background: var(--preview-color-elevated); border: 1px solid var(--preview-color-border); }
  input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: var(--preview-color-brand); border: 1px solid color-mix(in oklab, var(--preview-color-brand) 65%, black); }

  .preview-footer { padding: 12px 16px; border-top: 1px solid var(--preview-color-border); background: var(--preview-color-surface); color: var(--preview-color-text-muted); }
  .tiny { font-size: 12px; }
  .toolbar { display: flex; gap: 8px; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .toast { position: fixed; inset-inline: auto 16px; bottom: 16px; background: #0f1116; color: #e6e7ea; border: 1px solid #303540; border-radius: 10px; padding: 10px 12px; opacity: 0; pointer-events: none; transform: translateY(10px); transition: opacity .2s, transform .2s; }
  .toast.show { opacity: 1; transform: translateY(0); }
</style>
<!-- This style block will be filled programmatically with generated tokens -->
<style id="dynamicTokens"></style>
</head>
<body>
  <div class="wrap">
    <h1>OKLCH Ramp Builder + Live Preview</h1>
    <div class="layout">

      <!-- LEFT: Controls + Outputs -->
      <div class="stack card">
        <div class="card">
          <h2>Inputs</h2>
          <label for="seedHex">Seed HEX (brand)</label>
          <input id="seedHex" type="text" value="#7B458F" />

          <div class="row">
            <div style="flex:1 1 140px">
              <label for="brandHue">Brand Hue (°) <span class="muted">(optional)</span></label>
              <input id="brandHue" type="number" placeholder="auto from seed" step="1" min="0" max="360" />
            </div>
            <div style="flex:1 1 140px">
              <label for="brandChroma">Brand Mid-Chroma (C) <span class="muted">(optional)</span></label>
              <input id="brandChroma" type="number" placeholder="auto from seed" step="0.01" min="0" max="0.45" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1 1 140px">
              <label for="neutralHue">Neutral Hue (°)</label>
              <input id="neutralHue" type="number" value="280" step="1" min="0" max="360" />
              <div class="muted tiny">Cool ≈ 260–290 • Warm ≈ 40–60</div>
            </div>
            <div style="flex:1 1 140px">
              <label for="neutralChroma">Neutral Chroma (C)</label>
              <input id="neutralChroma" type="number" value="0.01" step="0.005" min="0" max="0.08" />
              <div class="muted tiny">Keep small (0.01–0.02) for gray</div>
            </div>
          </div>

          <label for="brandLs">Brand Lightness stops (L) – 10 values for 50→900</label>
          <textarea id="brandLs">0.98,0.93,0.86,0.78,0.70,0.62,0.54,0.46,0.38,0.30</textarea>
          <span class="muted tiny">Aim ~0.07–0.08 apart in the middle; smaller steps toward the dark end.</span>

          <label for="neutralLs">Neutral Lightness stops (L) – 12 values for 25→950</label>
          <textarea id="neutralLs">0.99,0.97,0.93,0.87,0.80,0.72,0.63,0.53,0.42,0.31,0.20,0.12</textarea>

          <div class="row" style="margin-top:12px">
            <button id="runBtn" class="btn">Generate Ramps</button>
            <a id="downloadJson" class="btn secondary" download="oklch-ramps.json" href="#" aria-disabled="true">Download JSON</a>
          </div>
        </div>

        <div class="card">
          <div class="toolbar">
            <h2 style="margin:0">CSS Variables</h2>
            <button id="copyCssBtn" class="btn small tertiary" type="button">Copy CSS</button>
          </div>
          <pre id="cssOut">/* Generate to see variables here */</pre>
        </div>

        <div class="card">
          <h2>JSON Output</h2>
          <pre id="jsonOut">{}</pre>
        </div>

        <div class="card">
          <h2>Brand Ramp (HEX)</h2>
          <div id="brandSwatches" class="swatches"></div>
          <table id="brandTable" style="margin-top:10px">
            <thead><tr><th>Token</th><th>HEX</th><th>L</th><th>C</th><th>H</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card">
          <h2>Neutral Ramp (HEX)</h2>
          <div id="neutralSwatches" class="swatches"></div>
          <table id="neutralTable" style="margin-top:10px">
            <thead><tr><th>Token</th><th>HEX</th><th>L</th><th>C</th><th>H</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT: Live Preview -->
<div class="preview">
  <!-- Toolbar -->
  <div class="card preview-toolbar">
    <div><strong>Live Preview</strong> <span class="muted">updates when you Generate</span></div>
    <div class="row">
      <button id="lightBtn" class="btn secondary" type="button">Light</button>
      <button id="darkBtn" class="btn secondary" type="button">Dark</button>
      <span class="chip" id="brandChip">Brand: #7B458F</span>
    </div>
  </div>

  <!-- Canvas -->
  <div class="preview-canvas" id="previewRoot" data-theme="light">

    <!-- Header (brand + nav + modal trigger) -->
    <div class="preview-header">
      <div class="brand"><span class="chip">◆ Brand</span></div>
      <nav class="nav" aria-label="Primary">
        <a href="#" class="nav-link" aria-current="page">Home</a>
        <a href="#" class="nav-link">Products</a>
        <a href="#" class="nav-link">Docs</a>
      </nav>
      <button class="button button--outline" type="button" id="openModalBtn">Open Modal</button>
    </div>

    <!-- Hero -->
    <div class="hero">
      <h2>OKLCH Colors in Action</h2>
      <p>This preview uses <code>brand-600</code> as primary, with hover/active from <code>700/800</code> and neutrals for surfaces.</p>
      <div class="hero-actions">
        <button class="button">Primary</button>
        <button class="button button--soft">Soft</button>
        <button class="button button--outline">Outline</button>
      </div>
    </div>

    <!-- UI Patterns Section -->
    <div class="section">
      <div class="grid3">
        <!-- Cards demo -->
        <div class="card">
          <h3>Cards</h3>
          <div class="grid3">
            <div class="card">
              <strong>Card A</strong>
              <p class="muted">Uses surface, border, text tokens.</p>
              <button class="button small">Action</button>
            </div>
            <div class="card">
              <strong>Card B</strong>
              <p class="muted">Hover and focus keep contrast.</p>
              <button class="button button--soft small">Secondary</button>
            </div>
            <div class="card">
              <strong>Card C</strong>
              <p class="muted">Outline variant stays on-brand.</p>
              <button class="button button--outline small">Outline</button>
            </div>
          </div>
        </div>

        <!-- Tabs demo -->
        <div class="grid3">
          <div class="card">
            <h3>Tabs</h3>
            <div class="tabs">
                <div class="tablist" role="tablist" aria-label="Sample tabs">
                <button class="tab" role="tab" aria-selected="true" aria-controls="tab1" id="t1">Overview</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab2" id="t2" tabindex="-1">Details</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab3" id="t3" tabindex="-1">Reviews</button>
                </div>
                <div id="tab1" class="tabpanel" role="tabpanel" aria-labelledby="t1">
                <p class="muted">Overview content uses body text tokens and surfaces.</p>
                </div>
                <div id="tab2" class="tabpanel" role="tabpanel" hidden aria-labelledby="t2">
                <p class="muted">Details content—check contrast in both themes.</p>
                </div>
                <div id="tab3" class="tabpanel" role="tabpanel" hidden aria-labelledby="t3">
                <p class="muted">Reviews content—links <a href="#">inherit brand color</a>.</p>
                </div>
            </div>
          </div>
          <!-- Accordion + Sliders -->
          <div class="card">
          <h3>Accordion & Sliders</h3>
          <div class="accordion" id="acc">
            <div class="accordion-item" aria-expanded="false">
              <button class="accordion-header" aria-controls="p1" id="h1">
                Color Settings <span aria-hidden="true">▸</span>
              </button>
              <div class="accordion-panel" id="p1" role="region" aria-labelledby="h1">
                <div class="range-row">
                  <label class="label tiny">Saturation (demo)</label>
                  <input type="range" min="0" max="100" value="60" />
                  <output class="muted tiny">60</output>
                </div>
                <div class="range-row">
                  <label class="label tiny">Emphasis (demo)</label>
                  <input type="range" min="0" max="100" value="30" />
                  <output class="muted tiny">30</output>
                </div>
              </div>
            </div>

            <div class="accordion-item" aria-expanded="false">
              <button class="accordion-header" aria-controls="p2" id="h2">
                Layout Options <span aria-hidden="true">▸</span>
              </button>
              <div class="accordion-panel" id="p2" role="region" aria-labelledby="h2">
                <p class="muted tiny">This content shows body contrast on elevated surfaces.</p>
              </div>
            </div>
          </div>
          </div>
          <!-- Notes -->
          <div class="card">
            <h3>Notes</h3>
            <p class="muted">Inline <a href="#">link</a> uses brand color; nav links behave like controls.</p>
          </div>
          
        </div>
        <!-- Badges (moved from hero) -->
          <div class="card">
            <h3>Badges</h3>
            <div class="actions" style="flex-wrap:wrap">
                <span class="badge badge--brand">Brand</span>
                <span class="badge badge--muted">Muted</span>
                <span class="badge badge--success">Success</span>
                <span class="badge badge--warning">Warning</span>
                <span class="badge badge--danger">Danger</span>
            </div>
            <p class="muted tiny" style="margin-top:8px">
                These use semantic tokens mapped from your generated ramps, so they auto-update in light/dark themes.
            </p>
          </div>
          <div class="card">
            <h3>Palette Tips</h3>
            <ul class="muted tiny" style="margin:0; padding-left: 1rem">
                <li>Use brand-600 for action fills; 700/800 for hover/active.</li>
                <li>Use neutral-50/100 surfaces in light; 800/900 in dark.</li>
                <li>Ensure text contrast ≥ 4.5:1 (normal text).</li>
            </ul>
          </div>
      </div>
    </div>

    <!-- Swatches -->
    <div class="section">
      <div class="grid3">
        <div class="card">
          <h3>Brand Swatches</h3>
          <div id="previewBrandSwatches" class="swatches"></div>
        </div>
        <div class="card">
          <h3>Neutral Swatches</h3>
          <div id="previewNeutralSwatches" class="swatches"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="preview-footer">
      © 2025 • WCAG-aware tokens • OKLCH ramps • semantic mapping • cards • modal • tabs • accordion • sliders
    </div>
  </div>
</div>

  </div>

<!-- dynamic token CSS goes in this <style> via JS -->
<style id="dynamicTokens"></style>
<div id="toast" class="toast" role="status" aria-live="polite">Copied CSS variables to clipboard.</div>

<!-- Modal -->
<div id="backdrop" class="modal-backdrop" aria-hidden="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
  <div role="dialog" aria-modal="true" class="modal">
    <header>
      <h3 id="modalTitle">Modal Title</h3>
      <button class="button button--outline small" id="closeModalBtn" aria-label="Close modal">Close</button>
    </header>
    <div id="modalDesc" class="muted">
      This modal uses surface, border, and brand tokens. Check contrast in light/dark themes.
    </div>
    <footer>
      <button class="button primary small" id="confirmBtn">Confirm</button>
      <button class="button secondary small" id="cancelModalBtn">Cancel</button>
    </footer>
  </div>
</div>

<script>
/* ========= OKLCH mini-kit ========= */
const clamp = (x,a,b)=>Math.min(b,Math.max(a,x));
const toFixedHex = x => clamp(Math.round(x*255),0,255).toString(16).padStart(2,'0');
const hexToRgb = hex => {
  const m = hex.replace('#','').match(/^([0-9a-f]{3}|[0-9a-f]{6})$/i);
  if(!m) throw Error("Bad HEX");
  let h = m[1].toLowerCase();
  if(h.length===3) h = [...h].map(c=>c+c).join('');
  return { r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16) };
};
const rgbToHex = ({r,g,b}) => `#${toFixedHex(r/255)}${toFixedHex(g/255)}${toFixedHex(b/255)}`;

const srgbToLinear = v => (v<=0.04045)? v/12.92 : Math.pow((v+0.055)/1.055,2.4);
const linearToSrgb = v => (v<=0.0031308)? 12.92*v : 1.055*Math.pow(v,1/2.4)-0.055;

function srgbToOklab(r8,g8,b8){
  const r = srgbToLinear(r8/255), g = srgbToLinear(g8/255), b = srgbToLinear(b8/255);
  const l = 0.4122214708*r + 0.5363325363*g + 0.0514459929*b;
  const m = 0.2119034982*r + 0.6806995451*g + 0.1073969566*b;
  const s = 0.0883024619*r + 0.2817188376*g + 0.6299787005*b;
  const l_=Math.cbrt(l), m_=Math.cbrt(m), s_=Math.cbrt(s);
  const L = 0.2104542553*l_ + 0.7936177850*m_ - 0.0040720468*s_;
  const a = 1.9779984951*l_ - 2.4285922050*m_ + 0.4505937099*s_;
  const b2= 0.0259040371*l_ + 0.7827717662*m_ - 0.8086757660*s_;
  return {L, a, b:b2};
}
function oklabToSrgb(L,a,b){
  const l_ = L + 0.3963377774*a + 0.2158037573*b;
  const m_ = L - 0.1055613458*a - 0.0638541728*b;
  const s_ = L - 0.0894841775*a - 1.2914855480*b;
  const l = l_**3, m = m_**3, s = s_**3;
  let r = +4.0767416621*l - 3.3077115913*m + 0.2309699292*s;
  let g = -1.2684380046*l + 2.6097574011*m - 0.3413193965*s;
  let bl= -0.0041960863*l - 0.7034186147*m + 1.7076147010*s;
  r = clamp(linearToSrgb(r),0,1);
  g = clamp(linearToSrgb(g),0,1);
  bl= clamp(linearToSrgb(bl),0,1);
  return { r:Math.round(r*255), g:Math.round(g*255), b:Math.round(bl*255) };
}
const rad2deg = x => x*180/Math.PI;
const deg2rad = x => x*Math.PI/180;
function oklabToOklch({L,a,b}) { const C = Math.hypot(a,b); let h = Math.atan2(b,a); if (h < 0) h += 2*Math.PI; return { L, C, H: rad2deg(h) }; }
function oklchToOklab({L,C,H}){ const h = deg2rad(H); return { L, a: C*Math.cos(h), b: C*Math.sin(h) }; }
function hexToOklch(hex){ const {r,g,b} = hexToRgb(hex); return oklabToOklch(srgbToOklab(r,g,b)); }
function oklchToHex(L,C,H){ const lab = oklchToOklab({L,C,H}); return rgbToHex(oklabToSrgb(lab.L, lab.a, lab.b)); }

/* ===== Ramp Generators ===== */
function buildBrandRamp(seedHex, Ls, opts={}){
  const seed = hexToOklch(seedHex);
  const H = (typeof opts.brandHueDeg === 'number') ? opts.brandHueDeg : seed.H;
  const midC = (typeof opts.midChroma === 'number') ? opts.midChroma : seed.C;
  const endC = (typeof opts.endChroma === 'number') ? opts.endChroma : (midC*0.55);
  const labels = [50,100,200,300,400,500,600,700,800,900];
  const N = Ls.length-1;
  return Ls.map((L,i)=>{
    const t = i/N; // 0..1
    const C = endC + (midC - endC) * (1 - Math.abs(0.5 - t)*2); // peak mid, ease ends
    const hex = oklchToHex(L, C, H);
    return { token:`--brand-${labels[i]}`, L:+L.toFixed(3), C:+C.toFixed(3), H:+H.toFixed(1), hex };
  });
}
function buildNeutralRamp({hueDeg=280, chroma=0.01, Ls}){
  const labels = [25,50,100,200,300,400,500,600,700,800,900,950];
  return Ls.map((L,i)=>{
    const hex = oklchToHex(L, chroma, hueDeg);
    return { token:`--gray-${labels[i]}`, L:+L.toFixed(3), C:+chroma.toFixed(3), H:+hueDeg.toFixed(1), hex };
  });
}

/* ===== UI Wiring ===== */
const $ = sel => document.querySelector(sel);
const dynamicStyle = $("#dynamicTokens");
const brandSwatches = $("#brandSwatches");
const brandTableBody = $("#brandTable tbody");
const neutralSwatches = $("#neutralSwatches");
const neutralTableBody = $("#neutralTable tbody");
const cssOut = $("#cssOut");
const jsonOut = $("#jsonOut");
const downloadLink = $("#downloadJson");
const copyCssBtn = $("#copyCssBtn");
const toast = $("#toast");

const brandChip = $("#brandChip");
const previewRoot = $("#previewRoot");
const prevBrandSwatches = $("#previewBrandSwatches");
const prevNeutralSwatches = $("#previewNeutralSwatches");

/* Theme toggle */
$("#lightBtn").addEventListener("click", ()=>{ previewRoot.dataset.theme="light"; });
$("#darkBtn").addEventListener("click", ()=>{ previewRoot.dataset.theme="dark"; });

function showToast(msg="Copied!") {
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 1500);
}
copyCssBtn.addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText(cssOut.textContent);
    showToast("Copied CSS variables to clipboard.");
  } catch {
    const ta = document.createElement("textarea");
    ta.value = cssOut.textContent;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    showToast("Copied CSS variables to clipboard.");
  }
});

function parseNumberList(str, expectedCount) {
  const arr = str.split(/[, \n\t]+/).map(s=>s.trim()).filter(Boolean).map(Number);
  if (arr.some(n => Number.isNaN(n))) throw Error("One or more Lightness values are not numbers.");
  if (expectedCount && arr.length !== expectedCount) throw Error(`Expected ${expectedCount} values, got ${arr.length}.`);
  return arr;
}
function renderSwatches(container, list) {
  container.innerHTML = list.map(item => `
    <div class="swatch" style="background:${item.hex}">
      <span class="tag">${item.token}</span>
    </div>
  `).join("");
}
function renderTable(tbody, list){
  tbody.innerHTML = list.map(item => `
    <tr>
      <td><code>${item.token}</code></td>
      <td><code>${item.hex}</code></td>
      <td>${item.L}</td><td>${item.C}</td><td>${item.H}</td>
    </tr>
  `).join("");
}
function toCssBlock(title, rows){
  const lines = rows.map(r => `  ${r.token}: ${r.hex};`).join("\n");
  return `/* ${title} */\n:root {\n${lines}\n}\n`;
}
function mapSemantics(brand, neutral){
  const by = {}; brand.forEach(x=>by[x.token]=x.hex);
  const gy = {}; neutral.forEach(x=>gy[x.token]=x.hex);

  return `
/* Primitive ramps */
:root {
${brand.map(x=>`  ${x.token}: ${x.hex};`).join('\n')}
${neutral.map(x=>`  ${x.token}: ${x.hex};`).join('\n')}
}

/* Semantic mapping for PREVIEW ONLY */
#previewRoot[data-theme="light"]{
  --preview-color-bg: ${gy['--gray-25']};
  --preview-color-surface: ${gy['--gray-50']};
  --preview-color-elevated: ${gy['--gray-100']};
  --preview-color-border: ${gy['--gray-200']};
  --preview-color-text: ${gy['--gray-900']};
  --preview-color-text-muted: ${gy['--gray-700']};

  --preview-color-brand: ${by['--brand-600']};
  --preview-color-brand-hover: ${by['--brand-700']};
  --preview-color-brand-active: ${by['--brand-800']};
  --preview-color-brand-soft: ${by['--brand-100']};

  --preview-text-on-brand: #ffffff;
  --preview-text-on-brand-hover: #ffffff;
  --preview-text-on-brand-soft: ${by['--brand-700']};

  /* Modal guidance */
  --preview-modal-surface: ${gy['--gray-100']};
  --preview-modal-text: ${gy['--gray-900']};
  --preview-modal-heading: ${by['--brand-500']};
  --preview-modal-primary-bg: ${by['--brand-600']};
  --preview-modal-primary-fg: #ffffff;
  --preview-modal-secondary-bg: ${gy['--gray-400']};
  --preview-modal-secondary-fg: ${gy['--gray-900']};

  --preview-success: #2E8B57; --preview-success-soft: #E9FFF5;
  --preview-warning: #B8860B; --preview-warning-soft: #FFF7E6;
  --preview-danger:  #C03631; --preview-danger-soft:  #FFEDEE;
}

#previewRoot[data-theme="dark"]{
  --preview-color-bg: ${gy['--gray-950']};
  --preview-color-surface: ${gy['--gray-900']};
  --preview-color-elevated: ${gy['--gray-800']};
  --preview-color-border: ${gy['--gray-700']};
  --preview-color-text: ${gy['--gray-25']};
  --preview-color-text-muted: ${gy['--gray-300']};

  --preview-color-brand: ${by['--brand-400']};
  --preview-color-brand-hover: ${by['--brand-300']};
  --preview-color-brand-active: ${by['--brand-500']};
  --preview-color-brand-soft: color-mix(in oklab, ${by['--brand-400']} 18%, transparent);

  --preview-text-on-brand: #ffffff;
  --preview-text-on-brand-hover: #ffffff;
  --preview-text-on-brand-soft: ${by['--brand-900']};

  /* Modal guidance */
  --preview-modal-surface: ${gy['--gray-700']};
  --preview-modal-text: ${gy['--gray-25']};
  --preview-modal-heading: ${by['--brand-500']};
  --preview-modal-primary-bg: ${by['--brand-600']};
  --preview-modal-primary-fg: #ffffff;
  --preview-modal-secondary-bg: ${gy['--gray-400']};
  --preview-modal-secondary-fg: ${gy['--gray-25']};

  --preview-success: #5ED0A2; --preview-success-soft: color-mix(in oklab, #5ED0A2 14%, transparent);
  --preview-warning: #FFC472; --preview-warning-soft: color-mix(in oklab, #FFC472 14%, transparent);
  --preview-danger:  #FF8C8A; --preview-danger-soft: color-mix(in oklab, #FF8C8A 14%, transparent);
}

/* Apply background/text from preview tokens */
#previewRoot{
  background: var(--preview-color-bg);
  color: var(--preview-color-text);
}
#previewRoot .preview-header,
#previewRoot .section,
#previewRoot .card,
#previewRoot .preview-footer{
  background: var(--preview-color-surface);
  border-color: var(--preview-color-border);
}
#previewRoot a { color: var(--preview-color-brand); text-decoration: underline; text-underline-offset: 2px; }
`;
}
function downloadJSON(dataObj){
  const blob = new Blob([JSON.stringify(dataObj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  downloadLink.href = url;
  downloadLink.setAttribute("aria-disabled","false");
}
function setBrandChip(hex){ brandChip.textContent = "Brand: " + hex.toUpperCase(); }

/* ===== Interactions: Modal, Tabs, Accordion, Sliders (single definitions) ===== */
const openModalButton = document.getElementById("openModalBtn");
const backdrop = document.getElementById("backdrop");
const closeModalButton = document.getElementById("closeModalBtn");
const cancelModalButton = document.getElementById("cancelModalBtn");

function openModal(){ backdrop.setAttribute("aria-hidden","false"); closeModalButton && closeModalButton.focus(); document.addEventListener("keydown", trap); }
function closeModal(){ backdrop.setAttribute("aria-hidden","true"); openModalButton && openModalButton.focus(); document.removeEventListener("keydown", trap); }
function trap(e){ if(e.key === "Escape") closeModal(); }
openModalButton && openModalButton.addEventListener("click", openModal);
closeModalButton && closeModalButton.addEventListener("click", closeModal);
cancelModalButton && cancelModalButton.addEventListener("click", closeModal);
backdrop && backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });

// Tabs
const tabs = Array.from(document.querySelectorAll('.tab'));
const panels = Array.from(document.querySelectorAll('.tabpanel'));
tabs.forEach(tab=>{
  tab.addEventListener('click', ()=>selectTab(tab));
  tab.addEventListener('keydown', (e)=>{
    const i = tabs.indexOf(tab);
    if(e.key === 'ArrowRight'){ tabs[(i+1)%tabs.length].click(); }
    if(e.key === 'ArrowLeft'){ tabs[(i-1+tabs.length)%tabs.length].click(); }
  });
});
function selectTab(active){
  tabs.forEach(t=>{
    const selected = (t===active);
    t.setAttribute('aria-selected', selected);
    t.tabIndex = selected ? 0 : -1;
  });
  panels.forEach(p=>{
    p.hidden = (p.id !== active.getAttribute('aria-controls'));
  });
  active.focus();
}

// Accordion
document.querySelectorAll('.accordion-item').forEach(item=>{
  const header = item.querySelector('.accordion-header');
  header.addEventListener('click', ()=>{
    const expanded = item.getAttribute('aria-expanded') === 'true';
    item.setAttribute('aria-expanded', String(!expanded));
    header.querySelector('span[aria-hidden="true"]').textContent = expanded ? '▸' : '▾';
  });
});

// Sliders: show live values
document.querySelectorAll('.range-row').forEach(row=>{
  const r = row.querySelector('input[type="range"]');
  const out = row.querySelector('output');
  r.addEventListener('input', ()=>{ out.textContent = r.value; });
});

/* ===== Generate ramps ===== */
document.getElementById("runBtn").addEventListener("click", () => {
  try{
    const seedHex = $("#seedHex").value.trim();
    if(!/^#?[0-9a-f]{6}$/i.test(seedHex) && !/^#?[0-9a-f]{3}$/i.test(seedHex)){
      alert("Please enter a valid HEX color, e.g., #7B458F");
      return;
    }
    const seedHexNormalized = seedHex.startsWith("#") ? seedHex : ("#"+seedHex);

    // Optional brand overrides
    const brandHueStr = $("#brandHue").value.trim();
    const brandChromaStr = $("#brandChroma").value.trim();
    const brandHue = brandHueStr === "" ? undefined : Number(brandHueStr);
    const brandMidC = brandChromaStr === "" ? undefined : Number(brandChromaStr);

    const neutralHue = Number($("#neutralHue").value);
    const neutralChroma = Number($("#neutralChroma").value);

    const LsBrand = parseNumberList($("#brandLs").value, 10);
    const LsNeutral = parseNumberList($("#neutralLs").value, 12);

    // Build ramps
    const brand = buildBrandRamp(seedHexNormalized, LsBrand, { brandHueDeg: brandHue, midChroma: brandMidC });
    const neutral = buildNeutralRamp({hueDeg: neutralHue, chroma: neutralChroma, Ls: LsNeutral});

    // Left column: swatches & tables
    renderSwatches(brandSwatches, brand);
    renderTable(brandTableBody, brand);
    renderSwatches(neutralSwatches, neutral);
    renderTable(neutralTableBody, neutral);

    // CSS vars
    const css = toCssBlock("Brand ramp variables", brand) + "\n" + toCssBlock("Neutral ramp variables", neutral);
    cssOut.textContent = css;

    // Inject preview mapping
    dynamicStyle.textContent = mapSemantics(brand, neutral);
    const brand600 = brand.find(x=>x.token==='--brand-600')?.hex || seedHexNormalized;
    setBrandChip(brand600);

    // Preview swatches (no nested template literals)
    const brandOrder = [50,100,200,300,400,500,600,700,800,900];
    const neutralOrder = [25,50,100,200,300,400,500,600,700,800,900,950];
    const brandMap = Object.fromEntries(brand.map(x=>[x.token,x.hex]));
    const neutralMap = Object.fromEntries(neutral.map(x=>[x.token,x.hex]));

    const brandPreviewHtml = brandOrder.map(n => {
      const key = "--brand-" + n;
      const hex = brandMap[key];
      return '<div class="swatch" style="background:' + hex + '"><span class="tag">' + key + '</span></div>';
    }).join("");

    const neutralPreviewHtml = neutralOrder.map(n => {
      const key = "--gray-" + n;
      const hex = neutralMap[key];
      return '<div class="swatch" style="background:' + hex + '"><span class="tag">' + key + '</span></div>';
    }).join("");

    prevBrandSwatches.innerHTML = brandPreviewHtml;
    prevNeutralSwatches.innerHTML = neutralPreviewHtml;

    // JSON
    const seedOKLCH = hexToOklch(seedHexNormalized);
    const actualBrandHue = (typeof brandHue === 'number') ? brandHue : +seedOKLCH.H.toFixed(1);
    const actualBrandMidC = (typeof brandMidC === 'number') ? brandMidC : +seedOKLCH.C.toFixed(3);
    const data = {
      seedHex: seedHexNormalized,
      seedOKLCH: { L:+seedOKLCH.L.toFixed(3), C:+seedOKLCH.C.toFixed(3), H:+seedOKLCH.H.toFixed(1) },
      brandControls: { brandHue: actualBrandHue, midChroma: actualBrandMidC, endChromaRatio: 0.55 },
      neutralControls: { hue: neutralHue, chroma: neutralChroma },
      brand, neutral
    };
    jsonOut.textContent = JSON.stringify(data, null, 2);
    downloadJSON(data);

  } catch(err){
    alert("Error: " + err.message);
  }
});

/* ===== Copy CSS ===== */
document.getElementById("copyCssBtn").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText(cssOut.textContent);
    showToast("Copied CSS variables to clipboard.");
  } catch {
    const ta = document.createElement("textarea");
    ta.value = cssOut.textContent;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    showToast("Copied CSS variables to clipboard.");
  }
});

// Modal open/close is defined once above
const confirmBtn = document.getElementById("confirmBtn");
confirmBtn && confirmBtn.addEventListener("click", closeModal);
</script>
</body>
</html>
